{% extends "base.html" %}
{% block title %}PicIntel Â· Analysis{% endblock %}

{% block styles %}
<style>
/* High-contrast styles for the authenticity summary box */
.auth-card {
  position: relative;
  background: #111828;            /* readable dark surface */
  color: #e8ecf1;                 /* light text */
  border: 1px solid rgba(255,255,255,.08);
  border-radius: 12px;
  padding: 16px 18px;
}
.auth-card .caption,
.auth-card .subcaption,
.auth-card .text-muted,
.auth-card .muted {
  color: #cfd6e3 !important;      /* high-contrast muted text */
  opacity: 1 !important;
}
.auth-card .headline,
.auth-card h4,
.auth-card h5,
.auth-card h6 {
  color: #ffffff !important;      /* strong heading */
}
/* Keep readable in light mode as well */
[data-theme="light"] .auth-card {
  background: #ffffff;
  color: #0b1220;
  border: 1px solid #e5e7eb;
}
[data-theme="light"] .auth-card .caption,
[data-theme="light"] .auth-card .subcaption,
[data-theme="light"] .auth-card .text-muted,
[data-theme="light"] .auth-card .muted {
  color: #5b6575 !important;
}
[data-theme="light"] .auth-card .headline,
[data-theme="light"] .auth-card h4,
[data-theme="light"] .auth-card h5,
[data-theme="light"] .auth-card h6 {
  color: #0b1220 !important;
}

/* Chatbot styles (shared) */
#chatbot-toggle {
  position: fixed; right: 24px; bottom: 24px; z-index: 9999;
  width: 56px; height: 56px; border-radius: 50%;
  background: #3b82f6; color: #fff; display: flex;
  align-items: center; justify-content: center; cursor: pointer;
  box-shadow: 0 6px 24px rgba(0,0,0,0.2); font-weight: 700; border: none;
}
#chatbot-panel {
  position: fixed; right: 24px; bottom: 90px; z-index: 9999;
  width: 320px; max-height: 60vh; border-radius: 12px;
  background: #111827; color: #e5e7eb; display: none;
  box-shadow: 0 12px 30px rgba(0,0,0,0.35); overflow: hidden; border: 1px solid #1f2937;
}
#chatbot-header {
  padding: 10px 12px; background: #1f2937; display: flex; align-items: center; justify-content: space-between;
}
#chatbot-body {
  padding: 12px; height: 300px; overflow-y: auto; background: #0b1220;
}
#chatbot-input { display: flex; gap: 8px; padding: 10px; background: #111827; border-top: 1px solid #1f2937; }
#chatbot-input input {
  flex: 1; padding: 10px 12px; border-radius: 8px; border: 1px solid #374151; background: #0f172a; color: #e5e7eb;
}
#chatbot-input button {
  padding: 10px 14px; border-radius: 8px; border: none; background: #10b981; color: #fff; font-weight: 600; cursor: pointer;
}
.msg { margin: 8px 0; line-height: 1.4; font-size: 14px; white-space: pre-wrap; }
.msg.user { text-align: right; color: #93c5fd; }
.msg.bot { text-align: left; color: #e5e7eb; }
</style>
{% endblock %}

{% block content %}
<div class="d-flex align-items-center justify-content-between mb-3">
  <div>
    <h3 class="mb-1">Analysis Results</h3>
    <div class="text-muted">Filename: {{ filename }}</div>
  </div>
  <div class="text-end">
    <span class="badge bg-success ai-chip me-2"><i class="fas fa-check-circle me-1"></i> Completed</span>
    <span class="badge bg-secondary ai-chip"><i class="fas fa-clock me-1"></i>{{ analysis.reverse_search.search_duration if analysis.reverse_search else 'â€”' }}</span>
  </div>
</div>

<div class="card shadow-sm mb-4">
  <div class="card-body">
    <div class="row g-4">
      <div class="col-md-5">
        <div class="border rounded p-2 bg-white">
          <img src="{{ url_for('uploaded_file', filename=filename) }}" class="img-fluid rounded" alt="Preview">
        </div>
      </div>
      <div class="col-md-7">
        <div class="row g-3">
          <div class="col-12">
            <div class="p-3 border rounded bg-light">
              <div class="d-flex align-items-center justify-content-between">
                <div>
                  <div class="text-muted small">AI Probability</div>
                  {% if analysis.reverse_search and analysis.reverse_search.ai_detection %}
                    <div class="display-6 fw-bold {% if analysis.reverse_search.ai_detection.risk_level in ['CRITICAL','HIGH RISK'] %}text-danger{% elif analysis.reverse_search.ai_detection.risk_level == 'WARNING' %}text-warning{% elif analysis.reverse_search.ai_detection.risk_level == 'CAUTION' %}text-info{% else %}text-success{% endif %}">
                      {{ analysis.reverse_search.ai_detection.ai_probability_percentage }}%
                    </div>
                    <div class="small">
                      <span class="badge {% if analysis.reverse_search.ai_detection.risk_level in ['CRITICAL','HIGH RISK'] %}bg-danger{% elif analysis.reverse_search.ai_detection.risk_level == 'WARNING' %}bg-warning{% elif analysis.reverse_search.ai_detection.risk_level == 'CAUTION' %}bg-info{% else %}bg-success{% endif %}">
                        {{ analysis.reverse_search.ai_detection.risk_level }}
                      </span>
                      <span class="text-muted ms-2">Confidence: {{ analysis.reverse_search.ai_detection.confidence }}</span>
                    </div>
                  {% else %}
                    <div class="text-muted">AI detection unavailable</div>
                  {% endif %}
                </div>
                <div class="text-end">
                  <button class="btn btn-outline-secondary btn-sm me-2" onclick="previewReport()">
                    <i class="fas fa-eye me-1"></i> Preview Report
                  </button>
                  <button class="btn btn-success btn-sm" onclick="downloadReport()">
                    <i class="fas fa-download me-1"></i> Download Report
                  </button>
                </div>
              </div>
            </div>
          </div>

          {% if analysis.metadata and analysis.metadata.basic_info %}
          <div class="col-12">
            <table class="table table-sm align-middle mb-0">
              <tbody>
                <tr>
                  <td class="text-muted">Dimensions</td>
                  <td>{{ analysis.metadata.basic_info.dimensions }}</td>
                  <td class="text-muted">Format</td>
                  <td>{{ analysis.metadata.basic_info.format }}</td>
                </tr>
                <tr>
                  <td class="text-muted">File Size</td>
                  <td>{{ analysis.metadata.basic_info.file_size_formatted or analysis.metadata.basic_info.file_size }}</td>
                  <td class="text-muted">Color Mode</td>
                  <td>{{ analysis.metadata.basic_info.mode }}</td>
                </tr>
                <tr>
                  <td class="text-muted">Transparency</td>
                  <td>{{ 'Yes' if analysis.metadata.basic_info.has_transparency else 'No' }}</td>
                  <td class="text-muted">Scanned</td>
                  <td>{{ analysis.metadata.analysis_timestamp[:19] if analysis.metadata.analysis_timestamp else 'â€”' }}</td>
                </tr>
              </tbody>
            </table>
          </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</div>

<ul class="nav nav-tabs" role="tablist">
  <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#ai">AI Detection</button></li>
  <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#exif">EXIF</button></li>
  <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#gps">GPS</button></li>
  <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#ocr">OCR</button></li>
  <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#reverse">Reverse Search</button></li>
  <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#auth">Authenticity</button></li>
</ul>

<div class="tab-content mt-3">
  <!-- AI Detection -->
  <div class="tab-pane fade show active" id="ai">
    {% if analysis.reverse_search and analysis.reverse_search.ai_detection %}
    <div class="row g-3">
      <div class="col-md-6">
        <div class="card h-100">
          <div class="card-header bg-white"><strong>Summary</strong></div>
          <div class="card-body">
            <div class="mb-2"><span class="text-muted">Assessment:</span> {{ analysis.reverse_search.ai_detection.assessment.replace('_', ' ').title() }}</div>
            <div class="mb-2"><span class="text-muted">Method:</span> {{ analysis.reverse_search.ai_detection.analysis_method }}</div>
            <div class="mb-2"><span class="text-muted">Models Checked:</span> {{ analysis.reverse_search.ai_detection.models_checked|join(', ') }}</div>
            {% if analysis.reverse_search.ai_detection.technical_details %}
            <hr>
            <div class="text-muted small mb-2">Technical Scores</div>
            <div class="row g-2 small">
              <div class="col-6">Noise: <strong>{{ analysis.reverse_search.ai_detection.technical_details.noise_score }}</strong></div>
              <div class="col-6">Frequency: <strong>{{ analysis.reverse_search.ai_detection.technical_details.frequency_score }}</strong></div>
              <div class="col-6">Artifacts: <strong>{{ analysis.reverse_search.ai_detection.technical_details.artifact_score }}</strong></div>
              <div class="col-6">Pixels: <strong>{{ analysis.reverse_search.ai_detection.technical_details.pixel_score }}</strong></div>
              <div class="col-6">Compression: <strong>{{ analysis.reverse_search.ai_detection.technical_details.compression_score }}</strong></div>
            </div>
            {% endif %}
          </div>
        </div>
      </div>
      <div class="col-md-6">
        <div class="card h-100">
          <div class="card-header bg-white"><strong>Indicators</strong></div>
          <div class="card-body">
            {% for indicator in analysis.reverse_search.ai_detection.indicators %}
            <div class="mb-2 p-2 rounded {% if 'âœ“' in indicator %}bg-success bg-opacity-10{% elif 'âš ' in indicator %}bg-warning bg-opacity-10{% elif 'ðŸš¨' in indicator %}bg-danger bg-opacity-10{% else %}bg-light{% endif %}">
              {{ indicator }}
            </div>
            {% endfor %}
          </div>
        </div>
      </div>
    </div>
    {% else %}
    <div class="alert alert-info">AI detection not available.</div>
    {% endif %}
  </div>

  <!-- EXIF -->
  <div class="tab-pane fade" id="exif">
    {% if analysis.metadata and analysis.metadata.exif_data %}
    <div class="card">
      <div class="card-body p-0">
        <table class="table table-hover mb-0">
          <tbody>
          {% for key, value in analysis.metadata.exif_data.items() %}
            <tr><td class="text-muted" style="width: 30%">{{ key }}</td><td><code>{{ value }}</code></td></tr>
          {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
    {% else %}
    <div class="alert alert-info">No EXIF data found.</div>
    {% endif %}
  </div>

  <!-- GPS -->
  <div class="tab-pane fade" id="gps">
    {% if analysis.metadata and analysis.metadata.gps_data and analysis.metadata.gps_data.latitude %}
    <div class="row g-3">
      <div class="col-md-5">
        <table class="table">
          <tr><td class="text-muted">Coordinates</td><td>{{ analysis.metadata.gps_data.coordinates_string }}</td></tr>
          <tr><td class="text-muted">Latitude</td><td>{{ analysis.metadata.gps_data.latitude }}</td></tr>
          <tr><td class="text-muted">Longitude</td><td>{{ analysis.metadata.gps_data.longitude }}</td></tr>
        </table>
        <a href="{{ analysis.metadata.gps_data.google_maps_url }}" target="_blank" class="btn btn-primary btn-sm">
          <i class="fas fa-map-location-dot me-1"></i> Open in Google Maps
        </a>
      </div>
      <div class="col-md-7">
        <div class="ratio ratio-16x9">
          <iframe src="https://maps.google.com/maps?q={{ analysis.metadata.gps_data.latitude }},{{ analysis.metadata.gps_data.longitude }}&z=15&output=embed" allowfullscreen></iframe>
        </div>
      </div>
    </div>
    {% else %}
    <div class="alert alert-warning">No GPS data present in this image.</div>
    {% endif %}
  </div>

  <!-- OCR -->
  <div class="tab-pane fade" id="ocr">
    {% if analysis.metadata and analysis.metadata.ocr_text and analysis.metadata.ocr_text != 'No text detected' %}
    <div class="card">
      <div class="card-body">
        <pre class="mb-0" style="white-space: pre-wrap;">{{ analysis.metadata.ocr_text }}</pre>
      </div>
    </div>
    {% else %}
    <div class="alert alert-info">No readable text detected in this image.</div>
    {% endif %}
  </div>

  <!-- Reverse Search -->
   <!-- Keep existing Reverse Search section UI unchanged above/below -->
<div style="margin: 8px 0;">
  <button id="rescanBtn" type="button">Rescan</button>
  <span id="rescanStatus" style="margin-left:10px;"></span>
</div>

<script>
  const btn = document.getElementById('rescanBtn');
  const statusEl = document.getElementById('rescanStatus');
  const rescanUrl = "{{ url_for('rescan', filename=filename) }}";
  btn.addEventListener('click', async () => {
    statusEl.textContent = 'Rescanning...';
    try {
      const resp = await fetch(rescanUrl, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({})  // no payload needed
      });
      const data = await resp.json();
      if (data.success) {
        statusEl.textContent = 'Rescan complete';
      } else {
        statusEl.textContent = data.error || 'Rescan failed';
      }
    } catch (e) {
      statusEl.textContent = 'Network error';
    }
  });
</script>

   <div class="tab-pane fade" id="reverse">
    {% if analysis.reverse_search %}
    <div class="alert alert-info">
      Found <strong>{{ analysis.reverse_search.matches_found }}</strong> matches in {{ analysis.reverse_search.search_duration }}
    </div>
    {% if analysis.reverse_search.results %}
    <div class="card">
      <div class="card-body p-0">
        <table class="table table-hover mb-0">
          <thead class="table-light">
            <tr><th>Score</th><th>Source</th><th>Context</th><th>Date</th><th></th></tr>
          </thead>
          <tbody>
          {% for result in analysis.reverse_search.results %}
            <tr>
              <td><span class="badge bg-success">{{ (result.match_score * 100)|round(1) }}%</span></td>
              <td><strong>{{ result.domain }}</strong><br><small class="text-muted">{{ result.title[:60] }}{% if result.title|length > 60 %}...{% endif %}</small></td>
              <td><span class="badge bg-primary">{{ result.context }}</span></td>
              <td>{{ result.first_found }}</td>
              <td class="text-end"><a href="{{ result.url }}" target="_blank" class="btn btn-sm btn-outline-primary">Open</a></td>
            </tr>
          {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
    {% endif %}
    {% else %}
    <div class="alert alert-warning">Reverse search not available.</div>
    {% endif %}
  </div>

  <!-- Authenticity -->
  <div class="tab-pane fade" id="auth">
    {% if analysis.reverse_search and analysis.reverse_search.authenticity_indicators %}
    <div class="row g-3">
      <div class="col-md-6">
        <!-- UPDATED: High-contrast authenticity summary -->
        <div class="auth-card h-100">
          <div class="caption">Overall Authenticity</div>
          <h4 class="headline mb-2">
            {{ analysis.reverse_search.authenticity_indicators.overall_authenticity.replace('_', ' ').title() }}
          </h4>
          <div class="subcaption">
            Manipulation Risk:
            <strong>{{ analysis.reverse_search.authenticity_indicators.manipulation_probability.title() }}</strong>
          </div>
        </div>
      </div>
      <div class="col-md-6">
        {% if analysis.reverse_search.similarity_analysis %}
        <table class="table mb-0">
          <tr><td class="text-muted">Feature Points</td><td>{{ analysis.reverse_search.similarity_analysis.feature_points }}</td></tr>
          <tr><td class="text-muted">Uniqueness</td><td>{{ analysis.reverse_search.similarity_analysis.uniqueness_score }}</td></tr>
          <tr><td class="text-muted">Complexity</td><td>{{ analysis.reverse_search.similarity_analysis.complexity_level }}</td></tr>
        </table>
        {% endif %}
      </div>
      {% if analysis.reverse_search.authenticity_indicators.technical_analysis %}
      <div class="col-12">
        <div class="card">
          <div class="card-header bg-white"><strong>Technical Analysis</strong></div>
          <div class="card-body">
            {% for point in analysis.reverse_search.authenticity_indicators.technical_analysis %}
            <div class="mb-2">{{ point }}</div>
            {% endfor %}
          </div>
        </div>
      </div>
      {% endif %}
    </div>
    {% else %}
    <div class="alert alert-warning">Authenticity indicators not available.</div>
    {% endif %}
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function downloadReport() {
  try {
    var analysisData = JSON.parse('{{ analysis|tojson|safe }}');
    var report = generateHumanReadableReport(analysisData, '{{ filename }}');
    var blob = new Blob([report], {type: 'text/plain'});
    var url = URL.createObjectURL(blob);
    var link = document.createElement('a');
    link.href = url;
    link.download = '{{ filename }}_PicIntel_Report.txt';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    URL.revokeObjectURL(url);
  } catch (error) {
    alert('Download failed: ' + error.message);
  }
}

function previewReport() {
  try {
    var analysisData = JSON.parse('{{ analysis|tojson|safe }}');
    var report = generateHumanReadableReport(analysisData, '{{ filename }}');

    var modal = document.createElement('div');
    modal.className = 'modal fade';
    modal.innerHTML = `
      <div class="modal-dialog modal-xl modal-dialog-scrollable">
        <div class="modal-content">
          <div class="modal-header bg-primary text-white">
            <h5 class="modal-title"><i class="fas fa-file-alt me-2"></i>PicIntel Report Preview</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <pre class="mb-0" style="white-space: pre-wrap;">${report}</pre>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            <button type="button" class="btn btn-success" onclick="downloadReport(); bootstrap.Modal.getInstance(this.closest('.modal')).hide();">
              <i class="fas fa-download me-2"></i>Download Report
            </button>
          </div>
        </div>
      </div>`;
    document.body.appendChild(modal);
    var bsModal = new bootstrap.Modal(modal);
    bsModal.show();
    modal.addEventListener('hidden.bs.modal', () => document.body.removeChild(modal));
  } catch (error) {
    alert('Preview failed: ' + error.message);
  }
}

/* Minimal report generator (keep your full version if you already have it) */
function generateHumanReadableReport(data, filename) {
  try {
    return 'PicIntel Report\n\n' + JSON.stringify(data, null, 2);
  } catch(e) {
    return 'PicIntel Report\n\n' + (data ? String(data) : 'No data');
  }
}
</script>

<!-- Chatbot floating UI (same as upload page) -->
<div id="chatbot-panel" aria-live="polite">
  <div id="chatbot-header">
    <div>PicIntel Assistant</div>
    <button id="chatbot-close" style="background:none;border:none;color:#9ca3af;cursor:pointer;">âœ•</button>
  </div>
  <div id="chatbot-body">
    <div class="msg bot">Need help understanding these results? Ask me anything.</div>
  </div>
  <div id="chatbot-input">
    <input id="chatbot-text" type="text" placeholder="Type a message..." />
    <button id="chatbot-send">Send</button>
  </div>
</div>

<button id="chatbot-toggle" title="Chat with assistant">ðŸ’¬</button>

<script>
(function() {
  const panel = document.getElementById('chatbot-panel');
  const toggle = document.getElementById('chatbot-toggle');
  const closeBtn = document.getElementById('chatbot-close');
  const body = document.getElementById('chatbot-body');
  const input = document.getElementById('chatbot-text');
  const send = document.getElementById('chatbot-send');

  function appendMsg(text, who='bot') {
    const div = document.createElement('div');
    div.className = 'msg ' + who;
    div.textContent = text;
    body.appendChild(div);
    body.scrollTop = body.scrollHeight;
  }

  toggle.addEventListener('click', () => {
    panel.style.display = (panel.style.display === 'block') ? 'none' : 'block';
    if (panel.style.display === 'block') input.focus();
  });

  closeBtn.addEventListener('click', () => { panel.style.display = 'none'; });

  function sendMsg() {
    const text = input.value.trim();
    if (!text) return;
    appendMsg(text, 'user');
    input.value = '';
    fetch('/chat', {
      method: 'POST',
      headers: {
  'Content-Type': 'application/json',
  'X-CSRFToken': document.querySelector('meta[name="csrf-token"]')?.content || ''
},
      body: JSON.stringify({ message: text })
    })
    .then(r => r.json())
    .then(data => {
      if (data.success && data.response && data.response.text) {
        appendMsg(data.response.text, 'bot');
      } else {
        appendMsg('Sorry, something went wrong with the chat.', 'bot');
      }
    })
    .catch(() => appendMsg('Network error. Please try again.', 'bot'));
  }

  send.addEventListener('click', sendMsg);
  input.addEventListener('keydown', (e) => { if (e.key === 'Enter') sendMsg(); });
})();
</script>
{% endblock %}








